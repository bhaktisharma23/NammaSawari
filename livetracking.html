<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Live Tracking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="livetracking.css">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Lucide -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

  <style>
    .route-info {
      background: rgb(77, 75, 75);
      padding: 12px;
      margin-top: 10px;
      border-radius: 12px;
      font-size: 14px;
      max-height: 200px;
      overflow-y: auto;
    }
    .status-on { color: green; font-weight: bold; }
    .status-delay { color: red; font-weight: bold; }
  </style>

</head>
<body>

<div class="container">

  <!-- Map -->
  <div id="map" class="map-box"></div>

  <!-- Filter -->
  <div class="filter-card">
    <label for="routeSelect">Filter by Route</label>
    <select id="routeSelect">
      <option value="">Loading nearby routes...</option>
    </select>
  </div>

  <!-- Extra Info -->
  <div id="routeInfo" class="route-info"></div>

  <div id="busList" class="bus-list"></div>

</div>

<script>
lucide.createIcons();

let map, userMarker;
let routeLines = [];
let routesData = [];

// Fake traffic + delay system
function getTrafficLevel() {
  const levels = ["low", "medium", "high"];
  return levels[Math.floor(Math.random() * levels.length)];
}
function getBusStatus() {
  return Math.random() > 0.6 ? "Delayed" : "On Time";
}

function initMap(lat, lon) {
  map = L.map('map').setView([lat, lon], 14);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap'
  }).addTo(map);

  userMarker = L.marker([lat, lon]).addTo(map)
    .bindPopup("You are here").openPopup();
}

// ðŸšŒ Load Bus Stops
function loadBusStops(lat, lon) {
  const radius = 1200;
  const query = `
    [out:json];
    node["highway"="bus_stop"](around:${radius},${lat},${lon});
    out body;
  `;

  fetch("https://overpass-api.de/api/interpreter", {
    method: "POST",
    body: query
  })
  .then(res => res.json())
  .then(data => {
    data.elements.forEach(stop => {
      L.circleMarker([stop.lat, stop.lon], {
        radius: 4,
        color: "red",
        fillColor: "red",
        fillOpacity: 1
      }).addTo(map)
      .bindPopup(stop.tags.name || "Bus Stop");
    });

    loadBusRoutes(lat, lon);
  });
}

// ðŸ›£ Load Routes
function loadBusRoutes(lat, lon) {
  const radius = 2000;
  const query = `
    [out:json];
    relation["route"="bus"](around:${radius},${lat},${lon});
    out tags body geom;
  `;

  fetch("https://overpass-api.de/api/interpreter", {
    method: "POST",
    body: query
  })
  .then(res => res.json())
  .then(data => {
    const dropdown = document.getElementById("routeSelect");
    dropdown.innerHTML = `<option value="">Select Bus Route</option>`;
    routesData = data.elements;

    data.elements.forEach((route, index) => {
      const number = route.tags.ref || "N/A";
      const name = route.tags.name || "Route";

      const option = document.createElement("option");
      option.value = index;
      option.textContent = `ðŸšŒ ${number} - ${name}`;
      dropdown.appendChild(option);
    });
  });
}

// ðŸ§­ Draw selected route + details
function drawRoute(routeIndex) {
  clearRoutes();
  const route = routesData[routeIndex];
  if (!route) return;

  const coords = [];
  const stops = [];

  if (route.members) {
    route.members.forEach(member => {
      if (member.role === "stop" && member.geometry) {
        member.geometry.forEach(pt => {
          stops.push(`Stop at (${pt.lat.toFixed(3)}, ${pt.lon.toFixed(3)})`);
        });
      }

      if (member.geometry) {
        member.geometry.forEach(point => {
          coords.push([point.lat, point.lon]);
        });
      }
    });
  }

  // Draw polyline with traffic color
  if (coords.length > 0) {
    let traffic = getTrafficLevel();
    let color = traffic === "high" ? "red" : traffic === "medium" ? "orange" : "blue";

    const polyline = L.polyline(coords, { color }).addTo(map);
    routeLines.push(polyline);
    map.fitBounds(polyline.getBounds());
  }

  // Show info panel
  const infoBox = document.getElementById("routeInfo");
  const fare = "â‚¹" + (10 + Math.floor(Math.random() * 20));
  const time = (20 + Math.floor(Math.random() * 40)) + " mins";
  const status = getBusStatus();

  infoBox.innerHTML = `
    <h3>ðŸšŒ Route Details</h3>
    <p><strong>Fare:</strong> ${fare}</p>
    <p><strong>Estimated Time:</strong> ${time}</p>
    <p><strong>Status:</strong> 
      <span class="${status === "On Time" ? "status-on" : "status-delay"}">
        ${status}
      </span>
    </p>
    <hr>
    <strong>Intermediate Stops:</strong>
    <ul>
      ${stops.slice(0, 10).map(s => `<li>${s}</li>`).join("") || "<li>No data available</li>"}
    </ul>
  `;
}

// âŒ Clear previous route lines
function clearRoutes() {
  routeLines.forEach(line => map.removeLayer(line));
  routeLines = [];
}

// ðŸŽ¯ Live GPS
function getLiveLocation() {
  if (!navigator.geolocation) {
    alert("Geolocation not supported");
    return;
  }

  navigator.geolocation.getCurrentPosition(pos => {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;

    initMap(lat, lon);
    loadBusStops(lat, lon);

  }, () => {
    alert("Location error");
  });
}

// Dropdown change
document.getElementById("routeSelect").addEventListener("change", function () {
  if (this.value !== "") {
    drawRoute(this.value);
  }
});

// Start
window.onload = getLiveLocation;
</script>

</body>
</html>
